<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Đánh giá sách - UTE BookStore</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" type="text/css" href="/css/review.css">
  <style>

  </style>
</head>
<body>

<div class="review-container">
  <!-- Header -->
  <div class="review-header">
    <h1>Đánh giá sách</h1>
  </div>

  <!-- Book Info -->
  <div class="book-info-card">
    <img th:src="@{'/images/books/' + ${book.picture}}"
         alt="Book Cover"
         class="book-thumbnail">
    <div class="book-details">
      <h3 th:text="${book.title}">Tên sách</h3>
      <p><strong>Tác giả:</strong> <span th:text="${book.author}"></span></p>
      <p><strong>Nhà xuất bản:</strong> <span th:text="${book.publisher}"></span></p>
      <p><strong>Giá:</strong> <span th:text="${#numbers.formatDecimal(book.price, 0, 'COMMA', 0, 'POINT')} + ' đ'"></span></p>
    </div>
  </div>

  <!-- Review Form -->
  <form th:action="@{/review/save}" id="reviewForm" method="post" class="review-form-content">
    <h1 class="review-title"
        th:text="${isUpdate} ? 'Chỉnh sửa đánh giá' : 'Đánh giá sản phẩm'">
    </h1>


    <input type="hidden" name="bookId" th:value="${bookId}">
    <input type="hidden" name="orderId" th:value="${orderId}">

    <!-- Success Message -->
    <div th:if="${param.success}" class="alert-success">
      ✓ Đánh giá của bạn đã được gửi thành công!
    </div>

    <!-- Star Rating -->
    <div class="form-group">
      <label class="form-label">Xếp hạng</label>
      <div class="star-rating">
        <input type="radio" id="star5" name="rating" value="5" required>
        <label for="star5">★</label>
        <input type="radio" id="star4" name="rating" value="4">
        <label for="star4">★</label>
        <input type="radio" id="star3" name="rating" value="3">
        <label for="star3">★</label>
        <input type="radio" id="star2" name="rating" value="2">
        <label for="star2">★</label>
        <input type="radio" id="star1" name="rating" value="1">
        <label for="star1">★</label>
        <span class="rating-value" id="ratingText"></span>
      </div>
    </div>

    <!-- Comment -->
    <div class="form-group">
      <label for="comment" class="form-label">Bình luận của bạn</label>
      <textarea id="comment" name="comment" class="form-control" placeholder="Chia sẻ những suy nghĩ của bạn về cuốn sách này..." maxlength="500"></textarea>
      <div class="char-counter"><span id="charCount">0</span>/500</div>
    </div>

    <!-- Buttons -->
    <div class="form-actions">
      <button type="submit" class="btn-submit">Gửi đánh giá</button>
      <a th:href="@{/user/myOrder}" class="btn-cancel">Hủy</a>
    </div>
  </form>
</div>

<script>
  document.getElementById("reviewForm").addEventListener("submit", function(e) {
    e.preventDefault(); // Chặn submit mặc định

    let form = e.target;
    let data = new FormData(form);
    let orderId = data.get("orderId");

    fetch("/review/save", {
      method: "POST",
      body: data
    }).then(() => {
      // Không tạo history entry
      history.replaceState(null, "", "/review/order/" + orderId);

      // Chuyển trang
      window.location.href = "/review/order/" + orderId;
    });
  });
</script>

<script>

  if (window.history && window.history.replaceState) {
    window.history.replaceState(null, null, window.location.href);
  }
  // Star rating display
  const ratingRadios = document.querySelectorAll('input[name="rating"]');
  const ratingText = document.getElementById('ratingText');
  const ratingTexts = {
    '1': 'Rất tệ',
    '2': 'Tệ',
    '3': 'Bình thường',
    '4': 'Tốt',
    '5': 'Tuyệt vời'
  };

  ratingRadios.forEach(radio => {
    radio.addEventListener('change', function() {
      ratingText.textContent = ratingTexts[this.value] + ` (${this.value}/5)`;
    });
  });

  // Character counter
  const commentField = document.getElementById('comment');
  const charCount = document.getElementById('charCount');

  commentField.addEventListener('input', function() {
    charCount.textContent = this.value.length;
  });
</script>

</body>
</html>
